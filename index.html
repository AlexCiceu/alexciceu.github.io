<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>MetaMex</title>
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
    <script src="sounds.js" type="text/javascript"></script>



</head>

<body>
        <div style="text-align:center;font-size:30px;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Donate: 381MpPNBN7wLaky88dyNtgA7WXEHfxdGri</div>

 
    <div class="tradingview-widget-container">
        <div id="tradingview_1875e"></div>
        <div class="tradingview-widget-copyright"><a href="https://www.tradingview.com/symbols/XBTUSD/" rel="noopener" target="_blank"><span class="blue-text">XBTUSD chart</span></a> by TradingView</div>
        <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
        <script type="text/javascript">
        new TradingView.widget(
        {
        "width": 980,
        "height": 610,
        "symbol": "XBTUSD",
        "interval": "3",
        "timezone": "Etc/UTC",
        "theme": "Light",
        "style": "1",
        "locale": "en",
        "toolbar_bg": "#f1f3f6",
        "enable_publishing": true,
        "withdateranges": true,
        "hide_side_toolbar": false,
        "allow_symbol_change": true,
        "container_id": "tradingview_1875e"
      }
        );
        </script>
      </div>
        <div id="root" style="text-align:center"></div>
    <audio id="audio1" src="audio/1.wav" autostart="false" ></audio>
    <audio id="audio2" src="audio/2.wav" autostart="false" ></audio>
    <audio id="audio3" src="audio/3.wav" autostart="false" ></audio>
    <audio id="audio4" src="audio/4.wav" autostart="false" ></audio>
    <audio id="audio5" src="audio/5.wav" autostart="false" ></audio>
    <audio id="audio6" src="audio/6.wav" autostart="false" ></audio>
    <audio id="audio7" src="audio/7.wav" autostart="false" ></audio>
    <audio id="audio8" src="audio/8.wav" autostart="false" ></audio>
    <audio id="audio9" src="audio/9.wav" autostart="false" ></audio>
    <audio id="audio10" src="audio/10.wav" autostart="false" ></audio>
    <audio id="audio11" src="audio/11.wav" autostart="false" ></audio>

    <style>
        h1{
            display:inline-block;
            padding:5px;
        }
        
        .root{
            min-height:100%;
        }
        .streamingTable {
            background-color: rgba(0, 0, 0, 0);
            border-collapse: collapse;
            border-spacing: 0;
            font-family: 'Open Sans', sans-serif;
            font-size: 14px;
            width:100%;
            min-height: 100%;
        }

        .streamingTable .streamingListRow td {
            padding: 5px;
            white-space: nowrap;
            border-left: 1px solid #ddd;
            text-align: right;
        }

        .streamingListRow {
            border-top: 1px solid #bbb;
        }

        .streamingTable .Buy {
            color: #4aa165;
        }

        .streamingTable tr.Dark.Buy {
            color: white;
            background-color: #4aa165;
        }

        .streamingTable .Sell {
            color: #d16547;
        }

        .streamingTable tr.Dark.Sell {
            color: white;
            background-color: #d16547;
        }

        .streamingListRow:nth-child(odd) {
            background: rgba(195, 195, 195, 0.25);
        }

        .streamingListRow:nth-child(even) {
            background: #fff;
            ;
        }

        .symbolInput {
            width: 120px;
            margin-right: 5px;
        }

        .priceInput {
            width: 170px;
            margin-right: 5px;
        }
    </style>

    <script type="text/babel">
    
    var sound1 = document.getElementById("audio1");
    var sound2 = document.getElementById("audio2");
    var sound3 = document.getElementById("audio3");
    var sound4 = document.getElementById("audio4");
    var sound5 = document.getElementById("audio5");
    var sound6 = document.getElementById("audio6");
    var sound7 = document.getElementById("audio7");
    var sound8 = document.getElementById("audio8");
    var sound9 = document.getElementById("audio9");
    var sound10 = document.getElementById("audio10");
    var sound11 = document.getElementById("audio11");

/*     function playSound() {         
          sound.play();
      }
    function pauseSound() {
        sound.pause();
    }
 */
    function playAudio(orderSize){
            if(orderSize >= 1 && orderSize <= 1000){
                sound1.play();
            } else if(orderSize >= 1001 && orderSize <= 2000){
                sound2.play();
            } else if(orderSize >= 2001 && orderSize <= 3000) {
                sound3.play();
            } else if(orderSize >= 5001 && orderSize <= 7500) {
                sound4.play();
            } else if(orderSize >= 7501 && orderSize <= 10000) {
                sound5.play();
            } else if(orderSize >= 10001 && orderSize <= 20000) {
                sound6.play();
            } else if(orderSize >= 20001 && orderSize <= 50000) {
                sound7.play();
            } else if(orderSize >= 50001 && orderSize <= 75000) {
                sound8.play();
            } else if(orderSize >= 75001 && orderSize <= 100000) {
                sound9.play();
            } else if(orderSize >= 100001 && orderSize <= 200000) {
                sound10.play();
            } else if(orderSize >= 200001) {
                sound11.play();
            }
    }

      function formatAMPM(date) {
        var hours = date.getHours();
        var minutes = date.getMinutes();
        var seconds = date.getSeconds();
        var ampm = hours >= 12 ? 'pm' : 'am';
        hours = hours % 12;
        hours = hours ? hours : 12; // the hour '0' should be '12'
        minutes = minutes < 10 ? '0'+minutes : minutes;
        seconds = seconds < 10 ? '0'+seconds : seconds;
        var strTime = hours + ':' + minutes + ':' + seconds + ' ' + ampm;
        return strTime;
      }
    function average(arr, priceFilter) {
        var sumSizeArr = {}, sumPriceArr= {}, results = [], timestamp, side;
        for (var i = 0; i < arr.length; i++) {
     		var item = arr[i];
       	var key = item.timestamp + item.side;
        if (!(key in sumSizeArr)) {
        		sumSizeArr[key] = {};
            sumSizeArr[key].sizeSum = item.size;
        } else {
          sumSizeArr[key].sizeSum += arr[i].size;
        }
    }
    
     for (var i = 0; i < arr.length; i++) {
     		var item = arr[i];
       	var key = item.timestamp + item.side;
        var sizeItem = sumSizeArr[key];
        if (!(key in sumPriceArr)) {
            sumPriceArr[key] = {};
            sumPriceArr[key].symbol = item.symbol;
            sumPriceArr[key].priceSum = item.price * item.size / sizeItem.sizeSum;
            sumPriceArr[key].sizeSum = item.size;
            sumPriceArr[key].timestamp = formatAMPM(new Date(item.timestamp));
            sumPriceArr[key].side = item.side;
        } else {
          sumPriceArr[key].priceSum += item.price * item.size / sizeItem.sizeSum;
          sumPriceArr[key].sizeSum += item.size;
        }
     }
    
    for(key in sumPriceArr) {
    		var item = sumPriceArr[key];
        if (item.sizeSum >= priceFilter-1)
        
        {
          results.push({ 
          symbol: item.symbol,
          price:item.priceSum.toFixed(2),
          size: item.sizeSum,
          timestamp: item.timestamp,
          side: item.side
          });
            var orderSize = item.sizeSum;
            console.log(orderSize);
            playAudio(orderSize);
        }
        
    }
    return results;
}
class TableRow extends React.Component {
  render() {
    const {data} = this.props;
    const row = data.map((data, i) =>
    <tr className={"streamingListRow " + (data.size > 99999 ? 'Dark ' : '') + (data.side == "Sell" ? 'Sell' : 'Buy')} key={i}>
      <td width="90">{data.price}</td>
      <td width="80">{data.size > 999 ? (data.size/1000).toFixed(0) + 'k' : data.size}</td>
      <td width="100">{data.timestamp}</td>
    </tr>
    );
    return (
    <tbody>{row}</tbody>
    );
  }
}

class Table extends React.Component {
  constructor(props) {
    super(props);
  }
  render() {
    return (
      <table className="streamingTable">
        <TableRow data={this.props.data} />
      </table>
    );
  }
}
class ShowData extends React.Component {
  constructor(props) {
    super(props);
    this.state = {data: []};
    this.instance = this;
  }
  
  initWebSocketClient(symbol, price) {
   if (symbol == null)
    {
    	 return null
    }
    var context = this.instance
    var streamingData = null;
    var priceFilter = isNaN(price) ? 0 : price;
    if (context.socket != null)
    {
    	context.socket.close();
      context.socket = null;
    }
    context.socket = new WebSocket("wss://www.bitmex.com/realtime?subscribe=trade:" + symbol.toUpperCase());
    context.socket.onmessage = function(event) {
      let obj = JSON.parse(event.data);
      if (obj.data == null)
      {
        return;
      }
      let data = average(obj.data, priceFilter);
			if (streamingData == null)
      {
          streamingData =data;
      }
      else
      {
      	if (streamingData.length > 100)
        {
        		streamingData.splice(streamingData.length - 20);
        }
      	streamingData = data.concat(streamingData);
      }
       context.setStreamData({data: streamingData});
     };
  }
  
  setStreamData(data){
      this.setState(data);
  }
  render() {
    return (
      <div>
         <Table data={this.state.data}/>
      </div>);
  	}
}
class SetSymbolView extends React.Component {
 constructor() {
      super();
      this.onSymbol = this.onSymbol.bind(this);
	  this.onKeyPress = this.onKeyPress.bind(this);
    }
    
	onKeyPress(e) {
		if (e.key === 'Enter') {
		  this.onSymbol();
		}
	}
	
    onSymbol() {
      this.dataComponent.initWebSocketClient(this.refs.symbol.value, parseInt(this.refs.minPrice.value));
    }
    
    render() {
    	return (
      <div>
        <input 
          ref="symbol"
          type="text" 
          name="symbolBox"
          className="symbolInput"
          placeholder="Enter symbol here..."
		  onKeyPress={this.onKeyPress}
        />
        <input 
          ref="minPrice"
          type="number" 
          name="minPriceBox"
          className="priceInput"
          placeholder="Min order size threshold..."
          min="0"
		  onKeyPress={this.onKeyPress}
        />
        <button onClick={this.onSymbol}>Submit</button>
        <p/>
        <div>
            <ShowData ref={instance => { this.dataComponent = instance; }}/>
        </div>
      </div>
   	  );
   }
}
 ReactDOM.render(<SetSymbolView />, document.getElementById('root'));
    </script>
</body>

</html>